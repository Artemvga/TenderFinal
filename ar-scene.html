<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>AR-квест «Образы Москвы» — сцена</title>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" name="viewport"/>
<meta content="yes" name="mobile-web-app-capable"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<!-- Стили -->
<link href="assets/css/style.css" rel="stylesheet"/>
<!-- A-Frame и MindAR -->
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
<!-- Основной JS -->
<script defer="" src="assets/js/main.js"></script>
<style>
    /* Дополнительные стили для фикса камеры */
    body.page--ar {
      position: fixed;
      width: 100%;
      height: calc(var(--vh, 1vh) * 100);
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
    }

    .camera-error {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      text-align: center;
    }

    .camera-error.active {
      display: flex;
    }

    .camera-error__content {
      max-width: 400px;
      color: white;
    }

    .camera-error__title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 12px;
    }

    .camera-error__text {
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.9;
      margin: 0 0 20px;
    }
    
    .camera-permission-prompt {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
      text-align: center;
    }
    
    .camera-permission-prompt.hidden {
      display: none;
    }
    
    .camera-permission-prompt__content {
      max-width: 400px;
      color: white;
    }
    
    .camera-permission-prompt__title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 12px;
    }
    
    .camera-permission-prompt__text {
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.9;
      margin: 0 0 20px;
    }
  </style>
</head>
<body class="page page--ar">
<!-- Запрос разрешения на камеру -->
<div class="camera-permission-prompt" id="cameraPermissionPrompt">
<div class="camera-permission-prompt__content">
<h2 class="camera-permission-prompt__title">Доступ к камере</h2>
<p class="camera-permission-prompt__text">
        Для работы AR-квеста необходим доступ к камере вашего устройства.
        Нажмите "Разрешить", чтобы начать сканирование картин.
      </p>
<button class="btn btn--primary" id="requestCameraBtn">
        Разрешить доступ к камере
      </button>
<button class="btn btn--light" onclick="window.location.href='index.html'" style="margin-top: 12px;">
        Вернуться в меню
      </button>
</div>
</div>
<!-- Сообщение об ошибке камеры -->
<div class="camera-error" id="cameraError">
<div class="camera-error__content">
<h2 class="camera-error__title">Нет доступа к камере</h2>
<p class="camera-error__text" id="cameraErrorText">
        Для работы AR необходим доступ к камере. Пожалуйста, разрешите доступ к камере в настройках браузера и попробуйте снова.
      </p>
<button class="btn btn--primary" id="retryCameraBtn">
        Попробовать снова
      </button>
<button class="btn btn--light" onclick="window.location.href='index.html'" style="margin-top: 12px;">
        Вернуться в меню
      </button>
</div>
</div>
<!-- AR-сцена: камера на фоне, UI поверх -->
<a-scene color-space="sRGB" device-orientation-permission-ui="enabled: false" embedded="" loading-screen="enabled: false" mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiError: no; uiScanning: no; filterMinCF: 0.0001; filterBeta: 0.001; cameraParam: { facingMode: { ideal: 'environment' } };" renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true; antialias: true; precision: medium;" vr-mode-ui="enabled: false">
<a-assets>
<!-- превью картины -->
<img crossorigin="anonymous" id="painting-preview" src="assets/png/Paint.png"/>
<!-- текстура точки интереса -->
<img crossorigin="anonymous" id="poi-dot" src="assets/png/POI_Dot.png"/>
</a-assets>
<!-- Камера -->
<a-camera look-controls="enabled: false" position="0 0 0"></a-camera>
<!-- Маркер MindAR -->
<a-entity id="artwork-target" mindar-image-target="targetIndex: 0">
<!-- Невидимая плоскость картины (1.5 × 1, центр — 0,0) -->
<a-plane height="1" material="opacity: 0; transparent: true" position="0 0 0" src="#painting-preview" width="1.5"></a-plane>
<!-- Точки интереса: три штуки близко к центру -->
<a-entity id="poi-group" visible="false">
<!-- POI 1 — слева от центра -->
<a-entity class="poi-wrapper" position="-0.25 0.05 0.02">
<a-image class="poi-icon" height="0.06" material="transparent: true; alphaTest: 0.5; depthTest: false;" src="#poi-dot" width="0.06"></a-image>
<a-circle class="poi-hit" data-poi="1" material="opacity: 0; transparent: true; depthTest: false;" radius="0.14"></a-circle>
</a-entity>
<!-- POI 2 — по центру -->
<a-entity class="poi-wrapper" position="0 0.05 0.02">
<a-image class="poi-icon" height="0.06" material="transparent: true; alphaTest: 0.5; depthTest: false;" src="#poi-dot" width="0.06"></a-image>
<a-circle class="poi-hit" data-poi="2" material="opacity: 0; transparent: true; depthTest: false;" radius="0.14"></a-circle>
</a-entity>
<!-- POI 3 — справа от центра -->
<a-entity class="poi-wrapper" position="0.25 0.05 0.02">
<a-image class="poi-icon" height="0.06" material="transparent: true; alphaTest: 0.5; depthTest: false;" src="#poi-dot" width="0.06"></a-image>
<a-circle class="poi-hit" data-poi="3" material="opacity: 0; transparent: true; depthTest: false;" radius="0.14"></a-circle>
</a-entity>
</a-entity>
</a-entity>
</a-scene>
<!-- UI поверх AR -->
<div class="ar-ui" data-ar-root="">
<!-- Большая квадратная кнопка выхода -->
<div class="ar-topbar safe-area-top">
<button aria-label="Выйти в меню" class="btn-back" data-action="exit-to-menu"></button>
</div>
<!-- Экран "Сканируем" при заходе -->
<div class="ar-overlay ar-overlay--scan" data-ar-scan="" style="display: none;">
<div class="ar-overlay__inner">
<img alt="Сканирование" class="ar-overlay__image" src="assets/png/Banner_ScanPicture.png"/>
<p class="ar-overlay__text" data-scan-text="">
          Наведите камеру на картину, чтобы начать.
        </p>
</div>
</div>
<!-- Вводная панель при первом распознавании -->
<div class="ar-overlay ar-overlay--panel" data-ar-intro="" hidden="">
<div class="panel">
<h2 class="panel__title">
          Репин Илья Ефимович «Торжественное заседание Государственного совета 7 мая
          1901 года в день столетнего юбилея со дня его учреждения». 1903 год.
        </h2>
<p class="panel__text">
          Картина была выполнена по правительственному заказу к 100-летнему юбилею
          Государственного совета, чтобы увековечить историческое событие в
          Мариинском дворце и показать всех участников заседания. Репин писал с
          натуры: он присутствовал на заседаниях, делал множество фотографий,
          просил сановников вести себя естественно и непременно занимать свои
          обычные места.
        </p>
<button class="btn btn--primary panel__button" data-action="close-intro">
          Перейти к точкам интереса
        </button>
</div>
</div>
<!-- Панель точки интереса -->
<div class="ar-overlay ar-overlay--panel" data-ar-poi-panel="" hidden="">
<div class="panel">
<h2 class="panel__title" data-poi-title=""></h2>
<p class="panel__text" data-poi-text=""></p>
<button class="btn btn--primary panel__button" data-action="close-poi">
          Закрыть
        </button>
</div>
</div>
</div>
<script>
// Камера / AR: стабильный запуск на мобильных + запрос разрешения
document.addEventListener('DOMContentLoaded', () => {
  const permissionPrompt = document.getElementById('cameraPermissionPrompt');
  const cameraError = document.getElementById('cameraError');
  const cameraErrorText = document.getElementById('cameraErrorText');
  const requestCameraBtn = document.getElementById('requestCameraBtn');
  const retryCameraBtn = document.getElementById('retryCameraBtn');
  const scanOverlay = document.querySelector('[data-ar-scan]');
  const sceneEl = document.querySelector('a-scene');

  // --- Детект устройства/браузера ---
  const ua = navigator.userAgent || '';
  const platform = navigator.platform || '';
  const maxTouchPoints = navigator.maxTouchPoints || 0;
  const isIpadOS = /MacIntel/i.test(platform) && maxTouchPoints > 1;
  const isIOS = isIpadOS || /iPad|iPhone|iPod/i.test(ua);
  const isAndroid = /Android/i.test(ua);
  const isYandex = /YaBrowser/i.test(ua);
  const isChrome = /Chrome|CriOS|Chromium/i.test(ua) && !isYandex && !/Edg|OPR/i.test(ua);
  const isSafari = /Safari/i.test(ua) && !/CriOS|FxiOS|EdgiOS|OPiOS|YaBrowser/i.test(ua) && !isAndroid;

  // Встроенные браузеры (часто ломают камеру/AR)
  const isInApp = /Instagram|FBAN|FBAV|TikTok|VKClient|VKA|Telegram/i.test(ua);

  // Подсказываем пользователю правильный браузер под ОС
  const promptTextEl = permissionPrompt
    ? permissionPrompt.querySelector('.camera-permission-prompt__text')
    : null;
  if (promptTextEl) {
    if (isIOS) {
      promptTextEl.textContent =
        'Для работы AR‑квеста нужен доступ к камере. На iPhone рекомендуем Safari. Нажмите "Разрешить", чтобы начать сканирование.';
    } else if (isAndroid) {
      promptTextEl.textContent =
        'Для работы AR‑квеста нужен доступ к камере. На Android рекомендуем Chrome или Яндекс Браузер. Нажмите "Разрешить", чтобы начать сканирование.';
    }
  }

  function setButtonLoading(isLoading) {
    if (!requestCameraBtn) return;
    if (!requestCameraBtn.dataset.originalText) {
      requestCameraBtn.dataset.originalText = requestCameraBtn.textContent.trim();
    }
    requestCameraBtn.disabled = !!isLoading;
    requestCameraBtn.textContent = isLoading
      ? 'Загрузка AR...'
      : (requestCameraBtn.dataset.originalText || 'Разрешить доступ к камере');
  }

  function showCameraError(message) {
    if (cameraErrorText) cameraErrorText.textContent = message;
    if (permissionPrompt) permissionPrompt.classList.add('hidden');
    if (cameraError) cameraError.classList.add('active');
  }

  function hideCameraError() {
    if (cameraError) cameraError.classList.remove('active');
  }

  // Проверяем HTTPS (обязательно для камеры)
  function checkHTTPS() {
    const isLocalhost =
      window.location.hostname === 'localhost' ||
      window.location.hostname === '127.0.0.1' ||
      window.location.hostname === '';
    const isHttps = window.location.protocol === 'https:';

    if (!isHttps && !isLocalhost) {
      showCameraError('Для доступа к камере сайт должен быть открыт по HTTPS.');
      return false;
    }
    return true;
  }

  function checkCameraSupport() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      showCameraError(
        'Ваш браузер не поддерживает доступ к камере. Используйте Safari (iPhone) или Chrome/Яндекс (Android).'
      );
      return false;
    }
    return true;
  }

  function checkInAppBrowser() {
    if (!isInApp) return true;

    if (isIOS) {
      showCameraError(
        'Похоже, вы открыли страницу во встроенном браузере приложения. На iPhone откройте ссылку в Safari ("Поделиться" → "Открыть в Safari") и повторите попытку.'
      );
    } else if (isAndroid) {
      showCameraError(
        'Похоже, вы открыли страницу во встроенном браузере приложения. На Android откройте ссылку в Chrome/Яндекс Браузере (меню → "Открыть в браузере") и повторите попытку.'
      );
    } else {
      showCameraError(
        'Похоже, вы открыли страницу во встроенном браузере приложения. Откройте ссылку во внешнем браузере и повторите попытку.'
      );
    }
    return false;
  }

  // --- Ожидание готовности MindAR ---
  function waitForMindARReady({ timeoutMs = 12000 } = {}) {
    return new Promise((resolve, reject) => {
      if (!sceneEl) {
        reject(new Error('SCENE_NOT_FOUND'));
        return;
      }

      const startedAt = Date.now();
      const tick = () => {
        const sys = sceneEl.systems && sceneEl.systems['mindar-image-system'];
        if (sys) {
          resolve(sys);
          return;
        }
        if (Date.now() - startedAt > timeoutMs) {
          reject(new Error('AR_ENGINE_TIMEOUT'));
          return;
        }
        setTimeout(tick, 200);
      };

      // Ждём, пока A-Frame поднимет systems
      if (sceneEl.hasLoaded) {
        setTimeout(tick, 0);
      } else {
        sceneEl.addEventListener('loaded', () => setTimeout(tick, 0), { once: true });
      }
    });
  }

  let mindARSystem = null;
  let arReady = false;

  async function queryCameraPermissionState() {
    try {
      if (!navigator.permissions || !navigator.permissions.query) return 'unknown';
      const status = await navigator.permissions.query({ name: 'camera' });
      return status && status.state ? status.state : 'unknown'; // granted | prompt | denied
    } catch (e) {
      return 'unknown';
    }
  }

  async function requestCameraPermission() {
    // Важно: на iOS/Safari запрос должен быть строго по клику — поэтому автозапрос делаем только на Android.
    const constraints = {
      audio: false,
      video: {
        facingMode: { ideal: 'environment' }
      }
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    // Освобождаем камеру сразу — дальше её возьмёт MindAR
    stream.getTracks().forEach(t => t.stop());
    // Небольшая пауза, чтобы камера успела освободиться
    await new Promise(r => setTimeout(r, 150));
    return true;
  }

  function startMindAR() {
    if (!mindARSystem) throw new Error('MINDAR_NOT_READY');
    if (!mindARSystem.sessionRunning) {
      return mindARSystem.start();
    }
    return Promise.resolve(true);
  }

  function onStartedSuccessfully() {
    hideCameraError();
    if (permissionPrompt) permissionPrompt.classList.add('hidden');
    if (scanOverlay) scanOverlay.style.display = 'flex';
  }

  function handleStartError(error) {
    console.error('MindAR start error:', error);
    let errorMessage = 'Не удалось запустить камеру. ';
    const name = (error && error.name) || '';

    if (name === 'NotAllowedError' || name === 'PermissionDeniedError') {
      errorMessage += 'Вы отклонили запрос. Разрешите доступ к камере в настройках браузера и попробуйте снова.';
    } else if (name === 'NotFoundError' || name === 'DevicesNotFoundError') {
      errorMessage += 'Камера не найдена. Убедитесь, что устройство имеет камеру.';
    } else if (name === 'NotReadableError' || name === 'TrackStartError') {
      errorMessage += 'Камера занята другим приложением. Закройте приложения, использующие камеру, и попробуйте снова.';
    } else if (name === 'OverconstrainedError' || name === 'ConstraintNotSatisfiedError') {
      errorMessage += 'Параметры камеры не поддерживаются. Попробуйте другой браузер.';
    } else if ((error && error.message) === 'AR_ENGINE_TIMEOUT') {
      errorMessage =
        'Не удалось загрузить AR‑движок. Проверьте интернет/блокировщики (AdBlock/VPN), затем обновите страницу.';
    } else {
      errorMessage += 'Пожалуйста, попробуйте ещё раз или откройте сайт в другом браузере.';
    }

    if (scanOverlay) scanOverlay.style.display = 'none';
    showCameraError(errorMessage);
  }

  async function runPrechecks() {
    if (!checkHTTPS() || !checkCameraSupport() || !checkInAppBrowser()) {
      if (permissionPrompt) permissionPrompt.classList.add('hidden');
      return false;
    }
    if (isIOS && !isSafari) {
      console.warn('iOS: рекомендуется Safari для максимально стабильной работы камеры.');
    }
    if (isAndroid && !(isChrome || isYandex)) {
      console.warn('Android: рекомендуется Chrome или Яндекс Браузер.');
    }
    return true;
  }

  // Старт по кнопке (гарантирует user gesture на iOS)
  async function startFromButton() {
    hideCameraError();
    if (!(await runPrechecks())) return;

    if (!arReady) {
      // на всякий случай — если пользователь кликнул слишком рано
      setButtonLoading(true);
      return;
    }

    // iOS: запускаем MindAR прямо из обработчика клика (без await ДО start())
    if (isIOS) {
      try {
        const p = startMindAR();
        p.then(onStartedSuccessfully).catch(handleStartError);
      } catch (e) {
        handleStartError(e);
      }
      return;
    }

    // Android/desktop: сначала просим разрешение, затем запускаем MindAR
    try {
      await requestCameraPermission();
      await startMindAR();
      onStartedSuccessfully();
    } catch (e) {
      handleStartError(e);
    }
  }

  // Автозапрос разрешения на Android (чтобы браузер сам показал системный запрос)
  async function autoRequestOnAndroid() {
    if (!isAndroid || isInApp) return;
    if (!(await runPrechecks())) return;

    // Только если AR уже готов
    if (!arReady) return;

    const state = await queryCameraPermissionState();
    if (state === 'denied') {
      // Пользователь уже отказал — только показываем кнопку/инструкцию
      return;
    }

    // Если permission state неизвестен — пробуем, но не ломаем UX, если браузер требует клика
    try {
      await requestCameraPermission();
      await startMindAR();
      onStartedSuccessfully();
    } catch (e) {
      // Часто сюда попадаем, если браузер требует user gesture — оставляем кнопку
      console.warn('Auto permission request failed, fallback to button:', e);
    }
  }

  // Освобождаем камеру при уходе со страницы
  function stopMindAR() {
    try {
      const sys = sceneEl && sceneEl.systems && sceneEl.systems['mindar-image-system'];
      if (sys && sys.sessionRunning) sys.stop();
    } catch (e) {
      // ignore
    }
  }

  // Инициализация
  (async () => {
    // Кнопка по умолчанию выключена, пока не готов AR-движок
    setButtonLoading(true);

    // Показываем пользователю явный промпт
    if (permissionPrompt) permissionPrompt.classList.remove('hidden');

    try {
      mindARSystem = await waitForMindARReady({ timeoutMs: 12000 });
      arReady = true;
      setButtonLoading(false);
      // Авто-запрос/авто-старт только на Android
      autoRequestOnAndroid();
    } catch (e) {
      // Не удалось поднять AR-движок (часто CDN/сеть)
      arReady = false;
      setButtonLoading(false);
      handleStartError(e);
    }
  })();

  // Обработчики
  if (requestCameraBtn) requestCameraBtn.addEventListener('click', startFromButton);
  if (retryCameraBtn) retryCameraBtn.addEventListener('click', startFromButton);

  window.addEventListener('pagehide', stopMindAR);
  window.addEventListener('beforeunload', stopMindAR);
});
</script>
</body>
</html>